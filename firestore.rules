  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      // Helper function to check if user is admin
      function isAdmin() {
        return request.auth != null && 
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
      }

      // Users can read/write their own profile
      match /users/{userId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
        allow read: if isAdmin();
      }
      
      // Users can read their own scans
      match /scans/{scanId} {
        allow read: if request.auth != null && resource.data.userId == request.auth.uid;
        allow create: if request.auth != null;
        allow read: if isAdmin();
      }
      
      // Only admins can read subscription events
      match /subscription_events/{eventId} {
        allow read: if isAdmin();
        allow create: if true; // Webhooks create these
      }

      // Testimonials - users can create, everyone can read approved ones, admins can read all
      match /testimonials/{testimonialId} {
        allow create: if request.auth != null && 
                        request.resource.data.userId == request.auth.uid &&
                        request.resource.data.approved == false; // Can only create unapproved
        allow read: if resource.data.approved == true || // Anyone can read approved testimonials
                      isAdmin(); // Admins can read all (including unapproved)
        allow update: if isAdmin(); // Only admins can approve/update
        allow delete: if isAdmin(); // Only admins can delete
      }

      // Scheduled scans
      match /scheduledScans/{scanId} {
        allow read, write: if request.auth != null && resource.data.userId == request.auth.uid;
        allow create: if request.auth != null && 
                        request.resource.data.userId == request.auth.uid;
      }

      // Developer API Keys - simplified for reliability
      match /apiKeys/{keyId} {
        // Create: authenticated user creating their own key with hashed key
        allow create: if request.auth != null &&
                      request.resource.data.userId == request.auth.uid &&
                      request.resource.data.keyHash is string;

        // Read: owner can read their own keys
        allow read: if request.auth != null && resource.data.userId == request.auth.uid;

        // Update: owner can update their own keys
        allow update: if request.auth != null && resource.data.userId == request.auth.uid;

        // Delete: owner can delete their own keys
        allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
      }
    }
  }
